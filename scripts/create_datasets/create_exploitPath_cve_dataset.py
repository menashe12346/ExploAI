import pandas as pd
import os

# ×§×•×‘×¥ ×”×§×œ×˜ ×•×”×¤×œ×˜
INPUT_CSV_PATH = "/home/menashe/cyber_ai_project/datasets/exploits/exploitdb/files_exploits.csv"
OUTPUT_CSV_PATH = "/home/menashe/cyber_ai_project/datasets/exploits/exploitdb/exploit_directory_with_id.csv"

# ×§×¨×™××ª ×”×§×•×‘×¥
try:
    df = pd.read_csv(INPUT_CSV_PATH, encoding="utf-8", on_bad_lines="skip", dtype=str)
    print(f"âœ… ×”×§×•×‘×¥ × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”! ×¡×š ×”×›×œ {len(df)} ×¨×©×•××•×ª.")
except Exception as e:
    print(f"âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×§×•×‘×¥: {e}")
    raise SystemExit

# ×™×¦×™×¨×ª ×”×¨×©×•××•×ª ×”×—×“×©×•×ª ×¢× ×œ×•×’×™×
output_data = []
total = len(df)

for i, row in df.iterrows():
    exploit_path = row.get("file", "").strip()
    exploit_id = row.get("id", "").strip()
    cve = row.get("codes", "")

    if pd.isna(cve) or not cve.strip():
        cve = "no cve"
    else:
        # ×‘×—×¨ ×¨×§ ××ª ×”-CVE ×”×¨××©×•×Ÿ ×× ×™×© ×›××” ××•×¤×¨×“×™× ×‘× ×§×•×“×”-×¤×¡×™×§
        cve = [code.strip() for code in cve.split(";") if "CVE" in code]
        cve = cve[0] if cve else "no cve"

    print(f"ğŸ” ×¢×•×‘×“ ×¢×œ Exploit {i+1}/{total} - {exploit_path} -> {cve}")
    output_data.append({
        "exploit_path": exploit_path,
        "cve": cve
    })

# ×©××™×¨×ª ×”×§×•×‘×¥ ×”×—×“×©
output_df = pd.DataFrame(output_data)
output_df.to_csv(OUTPUT_CSV_PATH, index=False, encoding="utf-8")
print(f"âœ… ×”×¡×ª×™×™×! ×”× ×ª×•× ×™× × ×©××¨×• ××œ: {OUTPUT_CSV_PATH}")
