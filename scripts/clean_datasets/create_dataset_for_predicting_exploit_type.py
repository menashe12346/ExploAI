import pandas as pd

# נתיבי קבצים
EXPLOIT_CSV = "/home/menashe/cyber_ai_project/datasets/exploits/exploitdb/exploit_v1.csv"
SERVER_CSV = "/home/menashe/cyber_ai_project/datasets/exploits/exploitdb/servers.csv"
OUTPUT_CSV = "/home/menashe/cyber_ai_project/datasets/exploits/exploitdb/matches.csv"

print("📥 טוען קבצים...")
df_exploits = pd.read_csv(EXPLOIT_CSV)
df_servers = pd.read_csv(SERVER_CSV)

# הפיכת עמודות לרשימות CPEs
print("🔧 ממיר CPE לרשימות...")
df_exploits["affected_products_list"] = df_exploits["affected_products"].fillna("").apply(lambda x: set([cpe.strip() for cpe in x.split(";") if cpe.strip()]))
df_servers["cpe_set"] = df_servers["cpe_raw"].fillna("").apply(lambda x: set([x.strip()]))  # אם יש יותר מ-CPE אחד לשרת, אפשר לשנות כאן

matches = []
total = len(df_exploits)
print("🚀 מתחיל להשוות אקפלויטים לשרתים...\n")

for i, row in df_exploits.iterrows():
    affected_set = row["affected_products_list"]
    if not affected_set:
        continue

    # השוואת set עם כל השרתים בבת אחת
    matched_servers = df_servers[df_servers["cpe_set"].apply(lambda s: bool(s & affected_set))]

    for _, server in matched_servers.iterrows():
        matches.append({
            "server_id": server["server_id"],
            "os_vendor": server["os_vendor"],
            "os_name": server["os_name"],
            "os_version": server["os_version"],
            "exploit_path": row["exploit_path"],
            "cve": row["cve"],
            "verified": row["verified"],
            "exploit_type": row["exploit_type"],
            "exploit_language": row["exploit_language"],
            "severity": row["severity"],
            "cvss_score": row["cvss_score"],
            "description": row["description"]
        })

    print(f"✅ [{i+1}/{total}] {row['exploit_path']} → נמצאו התאמות: {len(matched_servers)}")

# שמירת תוצאה
df_matches = pd.DataFrame(matches)
df_matches.to_csv(OUTPUT_CSV, index=False)
print(f"\n🎯 סך הכול התאמות: {len(matches)}")
print(f"💾 הקובץ נשמר: {OUTPUT_CSV}")
