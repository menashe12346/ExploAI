import pandas as pd

# × ×ª×™×‘×™ ×§×‘×¦×™×
EXPLOIT_CSV = "/home/menashe/cyber_ai_project/datasets/exploits/exploitdb/exploit_v1.csv"
SERVER_CSV = "/home/menashe/cyber_ai_project/datasets/exploits/exploitdb/servers.csv"
OUTPUT_CSV = "/home/menashe/cyber_ai_project/datasets/exploits/exploitdb/matches.csv"

print("ğŸ“¥ ×˜×•×¢×Ÿ ×§×‘×¦×™×...")
df_exploits = pd.read_csv(EXPLOIT_CSV)
df_servers = pd.read_csv(SERVER_CSV)

# ×”×¤×™×›×ª ×¢××•×“×•×ª ×œ×¨×©×™××•×ª CPEs
print("ğŸ”§ ×××™×¨ CPE ×œ×¨×©×™××•×ª...")
df_exploits["affected_products_list"] = df_exploits["affected_products"].fillna("").apply(lambda x: set([cpe.strip() for cpe in x.split(";") if cpe.strip()]))
df_servers["cpe_set"] = df_servers["cpe_raw"].fillna("").apply(lambda x: set([x.strip()]))  # ×× ×™×© ×™×•×ª×¨ ×-CPE ××—×“ ×œ×©×¨×ª, ××¤×©×¨ ×œ×©× ×•×ª ×›××Ÿ

matches = []
total = len(df_exploits)
print("ğŸš€ ××ª×—×™×œ ×œ×”×©×•×•×ª ××§×¤×œ×•×™×˜×™× ×œ×©×¨×ª×™×...\n")

for i, row in df_exploits.iterrows():
    affected_set = row["affected_products_list"]
    if not affected_set:
        continue

    # ×”×©×•×•××ª set ×¢× ×›×œ ×”×©×¨×ª×™× ×‘×‘×ª ××—×ª
    matched_servers = df_servers[df_servers["cpe_set"].apply(lambda s: bool(s & affected_set))]

    for _, server in matched_servers.iterrows():
        matches.append({
            "server_id": server["server_id"],
            "os_vendor": server["os_vendor"],
            "os_name": server["os_name"],
            "os_version": server["os_version"],
            "exploit_path": row["exploit_path"],
            "cve": row["cve"],
            "verified": row["verified"],
            "exploit_type": row["exploit_type"],
            "exploit_language": row["exploit_language"],
            "severity": row["severity"],
            "cvss_score": row["cvss_score"],
            "description": row["description"]
        })

    print(f"âœ… [{i+1}/{total}] {row['exploit_path']} â†’ × ××¦××• ×”×ª×××•×ª: {len(matched_servers)}")

# ×©××™×¨×ª ×ª×•×¦××”
df_matches = pd.DataFrame(matches)
df_matches.to_csv(OUTPUT_CSV, index=False)
print(f"\nğŸ¯ ×¡×š ×”×›×•×œ ×”×ª×××•×ª: {len(matches)}")
print(f"ğŸ’¾ ×”×§×•×‘×¥ × ×©××¨: {OUTPUT_CSV}")
