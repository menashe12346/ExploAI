import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import LabelEncoder
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import classification_report

# 📥 טען את הנתונים
df = pd.read_csv("/home/menashe/cyber_ai_project/datasets/exploits/exploitdb/matches.csv")

# ✂️ סינון רך - רק עמודות חיוניות
df = df.dropna(subset=["os_vendor", "os_name", "os_version", "exploit_type"])

# 🧹 טיפול בערכים חסרים
df["cvss_score"] = df["cvss_score"].fillna(0)

# 🧠 תכונות ועמודת מטרה
X = df[["os_vendor", "os_name", "os_version", "cvss_score", "severity", "exploit_language"]].copy()
y = df["exploit_type"]

# 🔣 קידוד קטגוריות
le_vendor = LabelEncoder()
le_name = LabelEncoder()
le_version = LabelEncoder()
le_severity = LabelEncoder()
le_language = LabelEncoder()
le_exploit = LabelEncoder()

X["os_vendor"] = le_vendor.fit_transform(X["os_vendor"])
X["os_name"] = le_name.fit_transform(X["os_name"])
X["os_version"] = le_version.fit_transform(X["os_version"])
X["severity"] = le_severity.fit_transform(X["severity"])
X["exploit_language"] = le_language.fit_transform(X["exploit_language"])
y = le_exploit.fit_transform(y)

# ✂️ חלוקה ל־Train/Test
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# 🤖 אימון המודל
clf = RandomForestClassifier(n_estimators=100, random_state=42)
clf.fit(X_train, y_train)

# 🔍 ניבוי והערכת ביצועים
y_pred = clf.predict(X_test)
print("📈 תוצאות על קבוצת הבדיקה:")
print(classification_report(y_test, y_pred, target_names=le_exploit.classes_))
